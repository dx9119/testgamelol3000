<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phaser WebSocket Game Client</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { margin: 0; background: #111; color: #0f0; font-family: monospace; }
        #log { position: fixed; top: 0; right: 0; width: 300px; max-height: 100%; overflow-y: auto; background: #222; padding: 10px; font-size: 12px; }
        button { margin: 5px; padding: 5px; font-size: 14px; }
    </style>
</head>
<body>
<div id="log"></div>
<button onclick="initPlayer()">Init Player</button>
<button onclick="movePlayer('U')">Move UP</button>
<button onclick="movePlayer('D')">Move DOWN</button>
<button onclick="movePlayer('L')">Move LEFT</button>
<button onclick="movePlayer('R')">Move RIGHT</button>
<button onclick="showSubscriptions()">Show Subscriptions</button>

<script>
    let stompClient = null;
    let subscriptions = {};
    let userName = null;
    let playerPos = {x: 0, y: 0};

    function log(message) {
        const logEl = document.getElementById("log");
        logEl.textContent += message + "\n";
        logEl.scrollTop = logEl.scrollHeight;
    }

    // --- Phaser –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
    const config = {
        type: Phaser.AUTO,
        width: 11*50, // 11 –∫–ª–µ—Ç–æ–∫ –ø–æ 50px
        height: 11*50,
        backgroundColor: '#111',
        parent: 'phaser-game',
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    let game = new Phaser.Game(config);
    let graphics;
    let playerRect;

    function preload() {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–µ–∫—Å—Ç—É—Ä—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    }

    function create() {
        graphics = this.add.graphics();
        drawGrid();

        // —Å–æ–∑–¥–∞—ë–º –∏–≥—Ä–æ–∫–∞ –∫–∞–∫ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
        playerRect = this.add.rectangle(0, 0, 50, 50, 0x00ff00);
        playerRect.setOrigin(0, 0);
        updatePlayerPosition();
    }

    function update() {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –¥–≤–∏–∂–µ–Ω–∏—è –∏–ª–∏ –ø–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
    }

    // --- –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É ---
    function drawGrid() {
        graphics.clear();
        graphics.lineStyle(1, 0x333333);
        for (let i = 0; i <= 11; i++) {
            graphics.moveTo(i*50, 0);
            graphics.lineTo(i*50, 11*50);
            graphics.moveTo(0, i*50);
            graphics.lineTo(11*50, i*50);
        }
        graphics.strokePath();
    }

    // --- –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞ –Ω–∞ Phaser —Å—Ü–µ–Ω–µ ---
    function updatePlayerPosition() {
        playerRect.x = playerPos.x * 50;
        playerRect.y = playerPos.y * 50;
    }

    // --- WebSocket/STOMP –∫–æ–¥ ---
    function connect() {
        const ws = new WebSocket("ws://localhost:8080/ws-game");
        stompClient = Stomp.over(ws);
        stompClient.debug = str => log("üß© STOMP: " + str);

        stompClient.connect({}, frame => {
            log("‚úÖ Connected to WebSocket");
            userName = frame.headers["user-name"];
            log(`üë§ Authenticated as: ${userName}`);

            const destination = `/user/${userName}/queue/events`;
            const sub = stompClient.subscribe(destination, msg => {
                try {
                    const payload = JSON.parse(msg.body);
                    if (payload.playerPosition && payload.playerPosition.x !== undefined) {
                        playerPos = { x: payload.playerPosition.x, y: payload.playerPosition.y };
                        log(`üìç Init position: x=${playerPos.x}, y=${playerPos.y}`);
                        updatePlayerPosition();
                    } else if (payload.x !== undefined && payload.y !== undefined) {
                        playerPos = { x: payload.x, y: payload.y };
                        log(`üéÆ Moved to: x=${playerPos.x}, y=${playerPos.y}`);
                        updatePlayerPosition();
                    } else {
                        log(`üì® Unknown payload: ${msg.body}`);
                    }
                } catch (e) {
                    log(`‚ö†Ô∏è Failed to parse message: ${msg.body}`);
                }
            });

            subscriptions[destination] = sub;
            log(`üì° Subscribed to: ${destination} ‚Üí id=${sub.id}`);

            initPlayer();
        }, error => log("‚ùå Connection error: " + error));
    }

    function initPlayer() {
        if (!stompClient) return;
        log("üöÄ Sending initPlayer");
        stompClient.send("/app/player/init", {}, {});
    }

    function movePlayer(direction) {
        if (!stompClient) return;
        const payload = JSON.stringify({ direction });
        log("‚û°Ô∏è Sending move: " + direction);
        stompClient.send("/app/player/move", {}, payload);
    }

    function showSubscriptions() {
        log("üì° Active subscriptions:");
        Object.keys(subscriptions).forEach(key => log(`üîó ${key} ‚Üí id=${subscriptions[key].id}`));
    }

    // --- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ---
    window.onload = connect;
</script>
</body>
</html>
