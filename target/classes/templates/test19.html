<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Game UI</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
        }
        .game-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            max-width: 1400px;
            margin: 0 auto;
        }
        .left-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 300px;
        }
        .right-panel {
            display: flex;
            flex-direction: column;
            min-width: 600px;
        }
        button {
            margin: 4px;
            padding: 12px 16px;
            font-size: 14px;
            cursor: pointer;
            background: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            transition: background 0.2s;
        }
        button:hover {
            background: #2ea043;
        }
        button:active {
            background: #196c2e;
        }
        #status {
            margin: 10px 0;
            font-weight: bold;
            font-size: 16px;
            padding: 10px;
            background: #161b22;
            border-radius: 8px;
            width: 100%;
            text-align: center;
        }
        canvas {
            border: 2px solid #30363d;
            background: #161b22;
            border-radius: 8px;
            margin: 10px 0;
        }
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 15px;
            background: #161b22;
            border-radius: 8px;
        }
        .arrow-buttons {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            gap: 6px;
            justify-items: center;
            margin: 10px 0;
        }
        .arrow-buttons button {
            width: 50px;
            height: 50px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .attack-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        .attack-controls input {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #e6edf3;
            padding: 8px;
            border-radius: 4px;
            width: 60px;
        }
        .info-panel {
            background: #161b22;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            width: 100%;
        }
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #58a6ff;
        }
        .coordinates {
            font-family: monospace;
            background: #0d1117;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #30363d;
        }
        .legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #30363d;
        }
    </style>
</head>
<body>
<h1>üéÆ –ò–≥—Ä–æ–≤–æ–π –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h1>

<div class="game-container">
    <div class="left-panel">
        <div class="controls">
            <div class="arrow-buttons">
                <div></div>
                <button onclick="sendDirection('U')" title="–î–≤–∏–∂–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö">‚¨ÜÔ∏è</button>
                <div></div>
                <button onclick="sendDirection('L')" title="–î–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ">‚¨ÖÔ∏è</button>
                <button onclick="sendInit()" title="–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞" style="background: #d29922;">üöÄ</button>
                <button onclick="sendDirection('R')" title="–î–≤–∏–∂–µ–Ω–∏–µ –≤–ø—Ä–∞–≤–æ">‚û°Ô∏è</button>
                <div></div>
                <button onclick="sendDirection('D')" title="–î–≤–∏–∂–µ–Ω–∏–µ –≤–Ω–∏–∑">‚¨áÔ∏è</button>
                <div></div>
            </div>

            <div class="attack-controls">
                <label for="attackX">–¶–µ–ª—å X:</label>
                <input type="number" id="attackX" value="0">
                <label for="attackY">–¶–µ–ª—å Y:</label>
                <input type="number" id="attackY" value="0">
                <button onclick="sendAttack()" style="background: #da3633;">üî´ –ê—Ç–∞–∫–æ–≤–∞—Ç—å</button>
            </div>

            <div>
                <button onclick="sendSell()" style="background: #8957e5;">üí∞ –ü—Ä–æ–¥–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã</button>
            </div>
        </div>

        <div id="status">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>

        <div class="info-panel">
            <h3>üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
            <div class="coordinates">
                <strong>–ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞:</strong>
                <span id="playerCoords">X: 0, Y: 0</span>
            </div>
            <div class="coordinates">
                <strong>–í–∏–¥–∏–º—ã–µ –æ–±—ä–µ–∫—Ç—ã:</strong>
                <span id="visibleObjects">–ö–ª–µ—Ç–∫–∏: 0, –í—Ä–∞–≥–∏: 0, –ò–≥—Ä–æ–∫–∏: 0</span>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <canvas id="gridCanvas" width="800" height="800"></canvas>

        <div class="info-panel">
            <h3>üìñ –õ–µ–≥–µ–Ω–¥–∞</h3>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: blue;"></div>
                    <span>–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–∂</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: lightblue;"></div>
                    <span>–î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: red;"></div>
                    <span>–í—Ä–∞–≥–∏ (–∂–∏–≤—ã–µ)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: darkred;"></div>
                    <span>–í—Ä–∞–≥–∏ (–º—ë—Ä—Ç–≤—ã–µ)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: green;"></div>
                    <span>–ü—É—Å—Ç–∞—è –∫–ª–µ—Ç–∫–∞</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: brown;"></div>
                    <span>–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: gray;"></div>
                    <span>–ö–ª–µ—Ç–∫–∞ —Å –æ–±—ä–µ–∫—Ç–æ–º</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let userName = null;
    let playerPos = { x: 0, y: 0 };
    let visibleCells = [];
    let visibleEnemies = [];
    let visiblePlayers = [];

    const canvas = document.getElementById('gridCanvas');
    const ctx = canvas.getContext('2d');
    const cellSize = 32;
    const gridSize = 25;

    function updateStatus(text, isError = false) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = text;
        statusDiv.style.color = isError ? '#f85149' : '#3fb950';
    }

    function updatePlayerInfo() {
        document.getElementById('playerCoords').textContent = `X: ${playerPos.x}, Y: ${playerPos.y}`;
        document.getElementById('visibleObjects').textContent =
        `–ö–ª–µ—Ç–∫–∏: ${visibleCells.length}, –í—Ä–∞–≥–∏: ${visibleEnemies.length}, –ò–≥—Ä–æ–∫–∏: ${visiblePlayers.length}`;
    }

    function renderGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = '10px monospace';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        ctx.strokeStyle = '#30363d';
        ctx.lineWidth = 0.5;

        for (let i = 0; i <= gridSize; i++) {
            ctx.beginPath();
            ctx.moveTo(i * cellSize, 0);
            ctx.lineTo(i * cellSize, canvas.height);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(0, i * cellSize);
            ctx.lineTo(canvas.width, i * cellSize);
            ctx.stroke();
        }

        ctx.fillStyle = '#58a6ff';
        ctx.font = '9px monospace';

        for (let i = 0; i < gridSize; i++) {
            const worldX = playerPos.x - Math.floor(gridSize / 2) + i;
            const worldY = playerPos.y - Math.floor(gridSize / 2) + i;

            ctx.fillText(worldX.toString(), i * cellSize + cellSize / 2, 10);
            ctx.fillText(worldY.toString(), 10, i * cellSize + cellSize / 2);
        }

        visibleCells.forEach(cell => {
            const relX = cell.x - playerPos.x;
            const relY = cell.y - playerPos.y;

            const centerOffset = Math.floor(gridSize / 2);
            const px = (relX + centerOffset) * cellSize;
            const py = (relY + centerOffset) * cellSize;

            if (px < 0 || px >= canvas.width || py < 0 || py >= canvas.height) {
                return;
            }

            if (cell.barrier) {
                ctx.fillStyle = 'brown';
            } else if (cell.isEmpty) {
                ctx.fillStyle = 'green';
            } else {
                ctx.fillStyle = 'gray';
            }

            ctx.fillRect(px, py, cellSize, cellSize);
            ctx.strokeStyle = '#444';
            ctx.strokeRect(px, py, cellSize, cellSize);

            ctx.fillStyle = 'white';
            ctx.font = '8px monospace';
            ctx.fillText(`(${cell.x},${cell.y})`, px + cellSize / 2, py + cellSize / 2 - 6);

            if (cell.objectOnCellName) {
                ctx.font = '7px monospace';
                ctx.fillStyle = '#ffd33d';
                ctx.fillText(cell.objectOnCellName, px + cellSize / 2, py + cellSize / 2 + 6);
            }
        });

        visibleEnemies.forEach(enemy => {
            const relX = enemy.position.x - playerPos.x;
            const relY = enemy.position.y - playerPos.y;

            const centerOffset = Math.floor(gridSize / 2);
            const ex = (relX + centerOffset) * cellSize;
            const ey = (relY + centerOffset) * cellSize;

            if (ex < 0 || ex >= canvas.width || ey < 0 || ey >= canvas.height) {
                return;
            }

            ctx.fillStyle = enemy.live ? 'red' : 'darkred';
            ctx.fillRect(ex, ey, cellSize, cellSize);
            ctx.strokeStyle = '#444';
            ctx.strokeRect(ex, ey, cellSize, cellSize);

            ctx.fillStyle = 'white';
            ctx.font = '8px monospace';
            ctx.fillText(enemy.name, ex + cellSize / 2, ey + 8);
            ctx.fillText(`HP:${enemy.HP}`, ex + cellSize / 2, ey + 20);
        });

        visiblePlayers.forEach(player => {
            const relX = player.x - playerPos.x;
            const relY = player.y - playerPos.y;

            const centerOffset = Math.floor(gridSize / 2);
            const px = (relX + centerOffset) * cellSize;
            const py = (relY + centerOffset) * cellSize;

            if (px < 0 || px >= canvas.width || py < 0 || py >= canvas.height) {
                return;
            }

            ctx.fillStyle = 'lightblue';
            ctx.fillRect(px, py, cellSize, cellSize);
            ctx.strokeStyle = '#444';
            ctx.strokeRect(px, py, cellSize, cellSize);

            ctx.fillStyle = 'white';
            ctx.font = '8px monospace';
            ctx.fillText(player.name, px + cellSize / 2, py + 8);
            ctx.fillText(`HP:${player.hp}`, px + cellSize / 2, py + 20);
        });

        const centerOffset = Math.floor(gridSize / 2);
        const playerPx = centerOffset * cellSize;
        const playerPy = centerOffset * cellSize;

        ctx.fillStyle = 'blue';
        ctx.fillRect(playerPx, playerPy, cellSize, cellSize);
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        ctx.strokeRect(playerPx, playerPy, cellSize, cellSize);

        ctx.fillStyle = 'white';
        ctx.font = '9px monospace';
        ctx.fillText('–í–´', playerPx + cellSize / 2, playerPy + cellSize / 2);

        updatePlayerInfo();
    }

    function initWebSocket() {
        updateStatus('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...');
        const socket = new WebSocket("ws://localhost:8080/ws-game");

        socket.onerror = e => {
            console.error(e);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', true);
        };

        socket.onclose = e => {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(3000 * reconnectAttempts, 10000);
                updateStatus(`üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${delay / 1000} —Å–µ–∫... (${reconnectAttempts}/${maxReconnectAttempts})`);
                setTimeout(initWebSocket, delay);
            } else {
                updateStatus('üö´ –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è', true);
            }
        };

        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, frame => {
            reconnectAttempts = 0;
            userName = frame.headers['user-name'];
            updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ' + userName);

            stompClient.subscribe(`/user/${userName}/queue/events`, msg => {
                try {
                    const pos = JSON.parse(msg.body);
                    playerPos = { x: pos.x, y: pos.y };
                    renderGrid();
                } catch (e) {
                    console.error(e);
                }
            });

            stompClient.subscribe(`/user/${userName}/queue/environment`, msg => {
                try {
                    const cells = JSON.parse(msg.body);
                    visibleCells = Array.isArray(cells) ? cells : [];
                    renderGrid();
                } catch (e) {
                    console.error(e);
                }
            });

            stompClient.subscribe(`/user/${userName}/queue/visibility`, msg => {
                try {
                    const data = JSON.parse(msg.body);
                    if (Array.isArray(data)) {
                        if (data.length > 0) {
                            if (data[0].position !== undefined) {
                                visibleEnemies = data;
                            } else if (data[0].x !== undefined) {
                                visiblePlayers = data;
                            }
                        }
                    }
                    renderGrid();
                } catch (e) {
                    console.error(e);
                }
            });

            stompClient.subscribe(`/user/${userName}/queue/combat`, msg => {
                try {
                    const combatData = JSON.parse(msg.body);
                } catch (e) {
                    console.error(e);
                }
            });

            stompClient.subscribe(`/user/${userName}/queue/loot`, msg => {
                try {
                    const lootData = JSON.parse(msg.body);
                } catch (e) {
                    console.error(e);
                }
            });

            stompClient.subscribe(`/user/${userName}/topic/inventory/sellResult`, msg => {
                try {
                    const sellData = JSON.parse(msg.body);
                } catch (e) {
                    console.error(e);
                }
            });
        });
    }

    function sendAttack() {
        const x = parseInt(document.getElementById('attackX').value, 10);
        const y = parseInt(document.getElementById('attackY').value, 10);
        if (isNaN(x) || isNaN(y)) {
            return;
        }
        const dto = { targetX: x, targetY: y };
        stompClient.send("/app/player/attack", {}, JSON.stringify(dto));
    }

    function sendDirection(direction) {
        if (!["U","D","L","R"].includes(direction)) return;
        const payload = { direction };
        stompClient.send("/app/player/move", {}, JSON.stringify(payload));
    }

    function sendInit() {
        stompClient.send("/app/player/init", {}, "");
    }

    function sendSell() {
        stompClient.send('/app/inventory/sell', {}, {});
    }

    window.addEventListener('load', function() {
        initWebSocket();
        renderGrid();
    });
</script>
</body>
</html>