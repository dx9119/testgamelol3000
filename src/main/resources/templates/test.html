<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Debug UI</title>
    <style>
        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #eee;
            padding: 20px;
        }
        button {
            margin: 5px;
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
        }
        #status {
            margin-bottom: 10px;
            font-weight: bold;
        }
        .log-container {
        display: flex;
        flex-direction: column; /* ‚Üê –∫–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä */
        gap: 20px;
        margin-top: 20px;
        }

        .log-panel {
            flex: 1;
            background: #111;
            color: #0f0;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #444;
            white-space: pre-wrap;
        }
        .log-title {
            margin-top: 0;
            color: #fff;
        }
    </style>
</head>
<body>

<h2>üß† WebSocket Debug UI</h2>
<div id="status">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>

<!-- –ö–Ω–æ–ø–∫–∏ -->
<div>
    <button onclick="sendDirection()">üö∂‚Äç‚ôÇÔ∏è –°–¥–µ–ª–∞—Ç—å —à–∞–≥</button>
    <button onclick="sendInit()">üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞</button>
    <button onclick="clearLogs()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
</div>

<button id="sellButton">–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë</button>



<!-- –ü–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∞—Ç–∞–∫–∏ -->
<div>
    <label for="attackX">X —Ü–µ–ª–∏:</label>
    <input type="number" id="attackX" value="1" style="width:60px;">
    <label for="attackY">Y —Ü–µ–ª–∏:</label>
    <input type="number" id="attackY" value="0" style="width:60px;">
    <button onclick="sendAttack()">üî´ –ê—Ç–∞–∫–æ–≤–∞—Ç—å</button>
</div>

<!-- –í—ã–±–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div>
    <label for="stepDirection">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</label>
    <select id="stepDirection">
        <option value="U">‚¨ÜÔ∏è –í–≤–µ—Ä—Ö</option>
        <option value="D">‚¨áÔ∏è –í–Ω–∏–∑</option>
        <option value="L">‚¨ÖÔ∏è –í–ª–µ–≤–æ</option>
        <option value="R">‚û°Ô∏è –í–ø—Ä–∞–≤–æ</option>
    </select>
</div>

<!-- –õ–æ–≥–∏ -->
<div class="log-container">
    <div>
        <h3>üìú –û—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏</h3>
        <pre id="wsLog" class="log-panel"></pre>
    </div>
    <div>
        <h3>üëÅÔ∏è –õ–æ–≥–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏</h3>
        <pre id="wsvisLog" class="log-panel"></pre>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>


<script>
    let stompClient;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let userName = null;


    const player = {
        updateName: name => logWS('CLIENT', 'PLAYER', { action: 'updateName', name }),
        handleServerPosition: pos => logWS('CLIENT', 'PLAYER', { action: 'handleServerPosition', pos })
    };
    const otherPlayersManager = {
        updateVisibility: players => logWSVIS('CLIENT', 'VISIBILITY', { action: 'updateVisibility', players }),
        removePlayer: id => logWS('CLIENT', 'DISCONNECT', { action: 'removePlayer', id })
    };
    const combatSystem = {
        handleCombatEvent: data => logWS('CLIENT', 'COMBAT', { action: 'handleCombatEvent', data })
    };

    const inventoryManager = {
        updateAfterSale(soldItemIds, goldReceived) {
            // üîÑ –£–¥–∞–ª—è–µ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
            soldItemIds.forEach(id => {
                const index = playerInventory.findIndex(item => item.itemId === id);
                if (index !== -1) {
                    console.log(`üßπ –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç ID=${id} –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è`);
                    playerInventory.splice(index, 1);
                }
            });

            // üí∞ –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
            playerGold += goldReceived;
            console.log(`üí∞ –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${playerGold}`);

            // üñºÔ∏è –û–±–Ω–æ–≤–ª—è–µ–º UI
            renderInventory(playerInventory);
            updateGoldDisplay(playerGold);

            // üîî –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±—ç–∫
            showToast(`–í—ã –ø—Ä–æ–¥–∞–ª–∏ ${soldItemIds.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏ –ø–æ–ª—É—á–∏–ª–∏ ${goldReceived} –º–æ–Ω–µ—Ç`);
        }
    };
    document.getElementById('sellButton').addEventListener('click', () => {
        try {
            stompClient.send('/app/inventory/sell', {}, {});
            logWS('WS-OUT', 'SellCommand', {});
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–¥–∞–∂–∏:', e);
        }
    });


    function logWS(type, tag, data) {
        const logArea = document.getElementById('wsLog');
        const timestamp = new Date().toLocaleTimeString();
        const entry = `[${timestamp}] [${type}] [${tag}] ${JSON.stringify(data, null, 2)}\n`;
        logArea.textContent += entry;
        logArea.scrollTop = logArea.scrollHeight;
    }

    function logWSVIS(type, tag, data) {
        const logArea = document.getElementById('wsvisLog');
        const timestamp = new Date().toLocaleTimeString();
        const entry = `[${timestamp}] [${type}] [${tag}] ${JSON.stringify(data, null, 2)}\n`;
        logArea.textContent += entry;
        logArea.scrollTop = logArea.scrollHeight;
    }

    function updateStatus(text, isError = false) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = text;
        statusDiv.style.color = isError ? 'red' : 'lime';
    }

    function clearLogs() {
        document.getElementById('wsLog').textContent = '';
        document.getElementById('wsvisLog').textContent = '';
    }

    function initWebSocket() {
        updateStatus('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...');
        const socket = new WebSocket("ws://localhost:8080/ws-game");

        socket.onerror = e => {
            console.error(e);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', true);
            logWS('CLIENT', 'ERROR', e);
        };

        socket.onclose = e => {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(3000 * reconnectAttempts, 10000);
                updateStatus(`üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${delay / 1000} —Å–µ–∫... (${reconnectAttempts}/${maxReconnectAttempts})`);
                setTimeout(initWebSocket, delay);
            } else {
                updateStatus('üö´ –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è', true);
            }
        };

        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, frame => {
            reconnectAttempts = 0;
            userName = frame.headers['user-name'];
            updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ' + userName);
            if (userName && player) player.updateName(userName);

            stompClient.subscribe(`/user/${userName}/queue/events`, msg => {
                try {
                    const pos = JSON.parse(msg.body);
                    logWS('WS-IN', 'Position', pos);
                    if (player) player.handleServerPosition(pos);
                } catch (e) {
                    console.error(e);
                }
            });

            stompClient.subscribe(`/user/${userName}/queue/visibility`, msg => {
                try {
                    const visibilityData = JSON.parse(msg.body);
                    logWSVIS('WS-IN', 'Visibility', visibilityData);
                    if (otherPlayersManager && visibilityData.visiblePlayers)
                        otherPlayersManager.updateVisibility(visibilityData.visiblePlayers);
                } catch (e) {
                    console.error(e);
                }
            });

            stompClient.subscribe(`/user/${userName}/queue/environment`, msg => {
                try {
                    const environmentData = JSON.parse(msg.body);
                    logWSVIS('WS-IN', 'Environment', environmentData);

                } catch (e) {
                    console.error(e);
                }
            });


            stompClient.subscribe(`/user/${userName}/queue/combat`, msg => {
                try {
                    const combatData = JSON.parse(msg.body);

                    // –õ–æ–≥–∏—Ä—É–µ–º –≤–µ—Å—å combatData –∫–∞–∫ –µ—Å—Ç—å
                    logWS('WS-IN', 'Combat', { raw: combatData });

                    if (combatSystem) {
                        combatSystem.handleCombatEvent(combatData);

                        logWS('CLIENT', 'CombatHandled', {
                            status: 'OK',
                            eventType: combatData?.targetName ? 'success' : 'miss',
                            fullPayload: combatData // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—ë, —á—Ç–æ –ø—Ä–∏—à–ª–æ
                        });
                    }
                } catch (e) {
                    console.error('[Combat][ERROR]', { error: e, raw: msg.body });
                }
            });

            stompClient.subscribe(`/user/${userName}/queue/loot`, msg => {
                try {
                    const lootData = JSON.parse(msg.body);

                    // –õ–æ–≥–∏—Ä—É–µ–º –≤–µ—Å—å lootData –∫–∞–∫ –µ—Å—Ç—å
                    logWS('WS-IN', 'Loot', { raw: lootData });

                    if (lootSystem) {
                        lootSystem.handleLootEvent(lootData);

                        logWS('CLIENT', 'LootHandled', {
                            status: 'OK',
                            source: lootData?.sourceObjectName ?? 'unknown',
                            items: lootData?.itemNames ?? [],
                            fullPayload: lootData
                        });
                    }
                } catch (e) {
                    console.error('[Loot][ERROR]', { error: e, raw: msg.body });
                }
            });



            stompClient.subscribe('/topic/player/disconnect', msg => {
                try {
                    const data = JSON.parse(msg.body);
                    logWS('WS-IN', 'Disconnect', data);
                    if (data.type === 'playerDisconnect' && data.playerId)
                        otherPlayersManager.removePlayer(data.playerId);
                } catch (e) {
                    console.error(e);
                }
            });

            stompClient.subscribe(`/user/${userName}/topic/inventory/sellResult`, msg => {
                try {
                    console.log("üì® –ü–æ–ª—É—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (sellResult):", msg.body);
                    logWS('WS-IN', 'SellResult', msg.body);
                } catch (e) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ sellResult:', e);
                }
            });



        }, err => {
            console.error(err);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', true);
        });
    }

    function sendAttack() {
        const x = parseInt(document.getElementById('attackX').value, 10);
        const y = parseInt(document.getElementById('attackY').value, 10);

        if (isNaN(x) || isNaN(y)) {
            logWS('CLIENT', 'ERROR', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∞—Ç–∞–∫–∏');
            return;
        }

        const dto = { targetX: x, targetY: y };
        stompClient.send("/app/player/attack", {}, JSON.stringify(dto));
        logWS('WS-OUT', 'Attack', dto);
    }

    function sendDirection() {
        const direction = document.getElementById('stepDirection').value;
        if (!direction || !["U", "D", "L", "R"].includes(direction)) {
            logWS('CLIENT', 'ERROR', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
            return;
        }
        if (!userName) {
            logWS('CLIENT', 'ERROR', '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ');
            return;
        }
        const payload = { direction };
        stompClient.send("/app/player/move", {}, JSON.stringify(payload));
        logWS('WS-OUT', 'MoveCommand', payload);
    }

    function sendInit() {
        stompClient.send("/app/player/init", {}, "");
        logWS('WS-OUT', 'Init', { command: 'initPlayer' });
    }

    initWebSocket();
</script>

</body>
</html>